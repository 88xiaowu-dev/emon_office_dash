<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emon-Toto Dashboard - Final Version</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- GLOBAL & BACKGROUND --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; min-height: 100vh;
            display: flex; align-items: center; justify-content: center;
            background-color: #1a1a1a;
            background-size: cover; background-position: center; background-attachment: fixed;
            transition: background 0.5s ease;
        }

        .bg-login { background-image: url('https://github.com/88xiaowu-dev/-xiaowurokok-/blob/main/emon%20bg%20dash.png?raw=true'); }
        .bg-home { background-image: url('https://github.com/88xiaowu-dev/-xiaowurokok-/blob/main/emon%20bg%20dash%201.png?raw=true'); }
        .bg-riwayat { background-image: url('https://github.com/88xiaowu-dev/-xiaowurokok-/blob/main/emon%20bg%20dash%202.png?raw=true'); }

        /* --- CONTAINER DASHBOARD --- */
        .container { 
            background: rgba(0, 0, 0, 0.5); width: 95%;
            max-width: 400px; border-radius: 20px; 
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 5px px rgb(245, 70, 1);
            border: 1px solid rgb(255, 217, 0);
            backdrop-filter: none;
            transition: max-width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dashboard-active { max-width: 1150px !important; flex-direction: row !important; height: 90vh; }

        /* --- SIDEBAR NAV --- */
        nav { 
            width: 260px; background: rgba(0, 0, 0, 0.5);
            padding: 30px 15px; display: none; flex-direction: column; gap: 10px;
            border-right: 1px solid rgba(255, 215, 0, 0.1);
        }
        
        nav button { 
            padding: 14px 18px; border-radius: 10px; border: none; cursor: pointer;
            background: transparent; color: #aaa; text-align: left; 
            transition: all 0.3s ease; font-weight: 500;
        }

        /* EFEK HOVER NAVIGASI */
        nav button:hover { 
            background: rgba(5, 240, 248, 0.15); 
            color: #05f0f8; 
            padding-left: 25px; 
        }

        nav button.active { background: #05f0f8; color: #000; font-weight: bold; }

        /* --- CONTENT AREA --- */
        .main-content { flex: 1; padding: 40px; display: none; color: white; overflow-y: auto; }

        /* JAM & TANGGAL */
        #digital-clock { 
            font-size: 3.8rem; color: #05f0f8; font-weight: bold; 
            font-family: 'Courier New', Courier, monospace;
            text-shadow: 0 0 25px rgba(5, 240, 248, 0.5); 
            line-height: 1; margin-bottom: 5px;
        }
        #realtime-date { color: #FFD700; font-size: 1.2rem; letter-spacing: 1px; }

        /* TOMBOL AKSI */
        .btn-action { 
            padding: 15px; border-radius: 10px; border: none; color: white; 
            font-weight: bold; cursor: pointer; flex: 1; 
            transition: all 0.3s ease; text-transform: uppercase; font-size: 0.9rem;
        }

        /* EFEK HOVER TOMBOL */
        .btn-action:hover { 
            filter: brightness(1.2); 
            transform: translateY(-3px); 
            box-shadow: 0 8px 20px rgba(0,0,0,0.4); 
        }
        .btn-action:active { transform: translateY(0); }

        /* TABEL MONITOR */
        .table-container { width: 100%; overflow-x: auto; margin-top: 20px; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.03); }
        th { background: rgba(5, 240, 248, 0.1); color: #05f0f8; padding: 15px; text-transform: uppercase; font-size: 0.8rem; }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: center; }

        /* EFEK HOVER BARIS TABEL */
        table tbody tr { transition: background 0.3s; }
        table tbody tr:hover { background: rgba(255, 255, 255, 0.08); }

        /* STATUS TIMER */
        .timer-safe { color: #28a745; font-weight: bold; }
        .timer-danger { color: #ff4d4d; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.4; } }

        /* SLOT INFO */
        .slot-info { 
            background: rgba(255, 215, 0, 0.05); color: #FFD700; 
            padding: 12px; border-radius: 10px; margin: 20px 0; 
            border: 1px dashed rgba(255, 215, 0, 0.3); font-size: 0.95rem; text-align: center;
        }

        /* LOGIN STYLE */
        #login-section input { 
            width: 100%; padding: 15px; margin-bottom: 20px; border-radius: 10px; 
            border: 1px solid #333; background: rgba(255,255,255,0.05); color: white; box-sizing: border-box; 
        }
        #login-section button { 
            width: 100%; padding: 15px; background: #ec5f0d; color: white; 
            border: none; font-weight: bold; border-radius: 10px; cursor: pointer;
            transition: all 0.3s ease; 
        }
        #login-section button:hover { background: #ff7518; box-shadow: 0 0 20px rgba(236, 95, 13, 0.5); }
    </style>
</head>
<body class="bg-login">

<div class="container">
    <div id="login-section">
        <div style="padding: 50px; text-align: center;">
            <h2 style="color:#FFD700; letter-spacing: 3px; margin-bottom: 40px;">LOGIN STAFF</h2>
            <input type="text" id="nik" placeholder="Masukkan Username">
            <input type="password" id="pass" placeholder="Password">
            <button onclick="handleLogin()">MASUK</button>
        </div>
    </div>

    <nav id="sidebar">
        <div style="text-align:center; color:#FFD700; margin-bottom:40px; font-size: 1.4rem; letter-spacing: 2px;"><b>EMON-TOTO</b></div>
        <button id="nav-home" onclick="showSection('home')">üè† Home</button>
        <button id="nav-riwayat" onclick="showSection('riwayat')">üìú Riwayat</button>
        <button onclick="logout()" style="margin-top:auto; color:#ff4d4d;">üö™ Keluar</button>
    </nav>

    <div id="main-content" class="main-content">
        <div id="sec-home">
            <h3 style="margin:0; font-weight: 400; color: #ccc;">Halo, <span id="user-name" style="color: white; font-weight: 700;">...</span></h3>
            <div style="margin: 20px 0;">
                <div id="digital-clock">00:00:00</div>
                <div id="realtime-date">Memuat Tanggal...</div>
            </div>

            <div id="slot-counter" class="slot-info">Mengecek ketersediaan slot...</div>

            <div style="display:flex; gap:15px; margin: 25px 0;">
                <button class="btn-action" style="background:#28a745" onclick="absen('masuk')">Absen Masuk</button>
                <button class="btn-action" style="background:#fd7e14" onclick="absen('pulang')">Absen Pulang</button>
            </div>
            
            <h4 style="display:flex; align-items:center; gap:10px;"><span style="font-size: 1.2rem;">üë§</span> Staf Sedang di Luar</h4>
            <div class="table-container">
                <table>
                    <thead><tr><th>Nama Staf</th><th>Keperluan</th><th>Sisa Waktu</th></tr></thead>
                    <tbody id="monitor-body"></tbody>
                </table>
            </div>

            <h4 style="margin-top:40px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">Form Izin</h4>
            <select id="keperluan" style="width:100%; padding:15px; background:#222; color:white; border-radius:10px; border:1px solid #444; margin-bottom: 15px;">
                <option value="">-- Pilih Keperluan --</option>
                <option value="Toilet">Toilet (15 Menit)</option>
                <option value="Ambil Makan">Ambil Makan (15 Menit)</option>
                <option value="Merokok">Merokok (15 Menit)</option>
                <option value="Istirahat">Istirahat (60 Menit)</option>
                <option value="Keperluan Khusus wanita">Keperluan Khusus wanita(15 Menit)</option>
            </select>
            <div style="display:flex; gap:15px;">
                <button id="btn-izin" onclick="izinKeluar()" class="btn-action" style="background:#007bff">Mulai Izin</button>
                <button onclick="izinKembali()" class="btn-action" style="background:#6c757d">Kembali</button>
            </div>
        </div>

        <div id="sec-riwayat" style="display:none">
            <h3>Riwayat Aktivitas</h3>
            <div class="table-container">
                <table style="min-width: 800px;">
                    <thead><tr><th>Nama</th><th>Keluar</th><th>Kembali</th><th>Durasi</th><th>Keperluan</th><th>Keterangan</th></tr></thead>
                    <tbody id="body-izin"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // KONFIGURASI SUPABASE
    const SB_URL = "https://crmuanjyoffemqoxqarj.supabase.co";
    const SB_KEY = "sb_publishable_0gKE7N1uNHMNEOzcZIEqHQ_OT4HcAHG";
    const client = supabase.createClient(SB_URL, SB_KEY);
    
    let userSession = null;
    let userProfile = null;
    let activeIzinData = [];

    // --- WAKTU & TANGGAL REALTIME ---
    function updateDateTime() {
        const now = new Date();
        document.getElementById('digital-clock').innerText = now.toLocaleTimeString('en-GB');
        document.getElementById('realtime-date').innerText = now.toLocaleDateString('id-ID', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });
        updateCountdowns();
    }
    setInterval(updateDateTime, 1000);

    // --- LOGIKA HITUNG MUNDUR (COUNTDOWN) ---
    function updateCountdowns() {
        const monitorBody = document.getElementById('monitor-body');
        if (!activeIzinData.length) return;

        let html = '';
        activeIzinData.forEach(iz => {
            const limitMenit = (iz.keperluan === 'Istirahat') ? 60 : 15;
            const limitMs = limitMenit * 60 * 1000;
            const elapsed = new Date().getTime() - new Date(iz.jam_keluar).getTime();
            const remaining = limitMs - elapsed;
            
            const isLate = remaining <= 0;
            const absRem = Math.abs(remaining);
            const m = Math.floor(absRem / 60000);
            const s = Math.floor((absRem % 60000) / 1000);
            
            const timerText = isLate ? `-${m}m ${s}s (Terlambat)` : `${m}m ${s}s`;
            
            html += `<tr>
                <td><b>${iz.nama_staf}</b></td>
                <td><span style="background:rgba(255,255,255,0.1); padding:4px 8px; border-radius:5px;">${iz.keperluan}</span></td>
                <td class="${isLate?'timer-danger':'timer-safe'}">${timerText}</td>
            </tr>`;
        });
        monitorBody.innerHTML = html;
    }

    // --- FETCH DATA MONITOR & SLOT ---
    async function fetchMonitor() {
        const { data: izinAktif } = await client.from('izin').select('user_id, jam_keluar, keperluan').is('jam_kembali', null);
        const { data: profiles } = await client.from('profiles').select('id, nama_staf');
        
        activeIzinData = (izinAktif || []).map(iz => ({
            ...iz,
            nama_staf: profiles.find(p => p.id === iz.user_id)?.nama_staf || 'Staf'
        }));

        const count = activeIzinData.length;
        const slotEl = document.getElementById('slot-counter');
        const btnIzin = document.getElementById('btn-izin');

        if (count >= 3) {
            slotEl.innerHTML = `‚ö†Ô∏è <b>SLOT PENUH!</b> Semua slot (3/3) sedang digunakan.`;
            slotEl.style.color = "#ff4d4d";
            btnIzin.style.opacity = "0.3";
            btnIzin.style.cursor = "not-allowed";
        } else {
            slotEl.innerHTML = `‚úÖ <b>SLOT TERSEDIA:</b> Tersisa ${3 - count} slot izin.`;
            slotEl.style.color = "#FFD700";
            btnIzin.style.opacity = "1";
            btnIzin.style.cursor = "pointer";
        }

        if (!activeIzinData.length) {
            document.getElementById('monitor-body').innerHTML = '<tr><td colspan="3" style="padding:30px; color:#00ff00;">‚úÖ Semua staf berada di kantor.</td></tr>';
        }
    }

    // --- FITUR IZIN ---
    async function izinKeluar() {
        const { data: currentOut } = await client.from('izin').select('id').is('jam_kembali', null);
        if (currentOut && currentOut.length >= 3) {
            alert("Batas maksimal 3 orang terpenuhi!");
            return;
        }

        const ket = document.getElementById('keperluan').value;
        if(!ket) return alert("Pilih keperluan Anda!");

        await client.from('izin').insert([{ 
            user_id: userSession.id, keperluan: ket, jam_keluar: new Date().toISOString() 
        }]);
        fetchMonitor();
    }

    async function izinKembali() {
        await client.from('izin').update({ jam_kembali: new Date().toISOString() })
            .match({ user_id: userSession.id }).is('jam_kembali', null);
        fetchMonitor();
    }

    // --- SESSION & NAVIGATION ---
    async function checkSession() {
        const { data: { session } } = await client.auth.getSession();
        if (session) {
            userSession = session.user;
            const { data: p } = await client.from('profiles').select('*').eq('id', userSession.id).single();
            userProfile = p;
            document.querySelector('.container').classList.add('dashboard-active');
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('sidebar').style.display = 'flex';
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('user-name').innerText = p?.nama_staf || 'User';
            showSection('home');
            setupRealtime();
        }
    }

    function setupRealtime() {
        client.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'izin' }, () => {
            fetchMonitor();
        }).subscribe();
    }

    function showSection(id) {
        document.getElementById('sec-home').style.display = id === 'home' ? 'block' : 'none';
        document.getElementById('sec-riwayat').style.display = id === 'riwayat' ? 'block' : 'none';
        document.body.className = 'bg-' + id;
        document.getElementById('nav-home').className = id === 'home' ? 'active' : '';
        document.getElementById('nav-riwayat').className = id === 'riwayat' ? 'active' : '';
        if(id === 'home') fetchMonitor(); else fetchRiwayat();
    }

    async function fetchRiwayat() {
        const namaUser = userProfile?.nama_staf || 'Staf';
        const { data: dbIzin } = await client.from('izin').select('*').eq('user_id', userSession.id).order('jam_keluar', {ascending: false});
        
        document.getElementById('body-izin').innerHTML = dbIzin?.map(i => {
            let durasiText = "-"; let statusBadge = "-";
            if (i.jam_kembali) {
                const diffMenit = Math.floor((new Date(i.jam_kembali) - new Date(i.jam_keluar)) / 60000);
                durasiText = diffMenit + "m";
                const limit = (i.keperluan === 'Istirahat') ? 60 : 15;
                statusBadge = diffMenit > limit ? `<span style="color:#ff4d4d; font-weight:bold;">Terlambat</span>` : `<span style="color:#28a745; font-weight:bold;">Tepat Waktu</span>`;
            } else { durasiText = "Diluar"; }
            
            return `<tr>
                <td><b>${namaUser}</b></td>
                <td>${new Date(i.jam_keluar).toLocaleTimeString()}</td>
                <td>${i.jam_kembali ? new Date(i.jam_kembali).toLocaleTimeString() : '-'}</td>
                <td>${durasiText}</td>
                <td>${i.keperluan}</td>
                <td>${statusBadge}</td>
            </tr>`;
        }).join('') || '';
    }

    async function handleLogin() {
        const nik = document.getElementById('nik').value;
        const pass = document.getElementById('pass').value;
        const { error } = await client.auth.signInWithPassword({ email: nik + "@kantor.com", password: pass });
        if (error) alert("Username atau Password salah!"); else location.reload();
    }

    async function absen(tipe) {
        if(tipe === 'masuk') {
            await client.from('absensi').insert([{ user_id: userSession.id, waktu_masuk: new Date().toISOString() }]);
        } else {
            await client.from('absensi').update({ waktu_pulang: new Date().toISOString() }).match({ user_id: userSession.id }).is('waktu_pulang', null);
        }
        alert("Berhasil dicatat!");
    }

    async function logout() { await client.auth.signOut(); location.reload(); }
    window.onload = checkSession;
</script>
</body>
</html>
