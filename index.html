<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emon-Toto Dashboard - Full & Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- GLOBAL & DYNAMIC BACKGROUND --- */
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; min-height: 100vh;
            background-size: cover; background-position: center; background-attachment: fixed;
            display: flex; align-items: center; justify-content: center;
            transition: background-image 0.8s ease-in-out;
        }

        /* Background per Menu */
        .bg-login { background-image: url('https://github.com/88xiaowu-dev/-xiaowurokok-/blob/main/emon%20bg%20dash.png?raw=true'); }
        .bg-home { background-image: url('https://github.com/88xiaowu-dev/-xiaowurokok-/blob/main/emon%20bg%20dash%201.png?raw=true'); }
        .bg-riwayat { background-image: url('https://github.com/88xiaowu-dev/-xiaowurokok-/blob/main/emon%20bg%20dash%202.png?raw=true'); }

        /* --- CONTAINER UTAMA (AUTO-WIDTH) --- */
        .container { 
            background: rgba(0, 0, 0, 0.3); width: 95%;
            max-width: 400px; min-height: 400px; border-radius: 20px; 
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 20px 60px rgba(247, 210, 110, 0.5);
            border: 1px solid rgb(255, 217, 0);
            transition: max-width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Mode Dashboard: Melebar Maksimal */
        .dashboard-active { max-width: 1200px !important; flex-direction: row !important; }

        /* --- LOGIN SECTION --- */
        #login-section { width: 100%; padding: 40px; text-align: center; box-sizing: border-box; }
        .login-box input, .login-box button {
            width: 100%; padding: 14px; margin-bottom: 15px;
            border-radius: 8px; border: 1px solid #444; box-sizing: border-box;
        }
        .login-box button { 
            background: #ec5f0d; color: white; border: none; font-weight: bold; cursor: pointer;
            margin-top: 20px; transition: 0.3s;
        }
        .login-box button:hover { background: #0056b3; transform: scale(1.02); }

        /* --- SIDEBAR NAVIGASI --- */
        nav { 
            width: 240px; background: rgba(10, 10, 10, 0.5);
            padding: 40px 20px; display: none; flex-direction: column; gap: 10px;
            border-right: 1px solid rgba(255, 215, 0, 0.1);
        }
        nav button { 
            padding: 14px; border-radius: 10px; border: none; cursor: pointer;
            background: transparent; color: #fdf6f6; text-align: left; transition: 0.3s;
        }
        nav button:hover { background: rgba(0, 123, 255, 0.2); color: #05f0f8; transform: translateX(8px); }
        nav button.active { background: #05f0f8; color: rgb(8, 8, 8); }

        /* --- CONTENT AREA (FULL TABLE) --- */
        .main-content { flex: 1; padding: 40px; display: none; color: white; overflow-y: auto; max-height: 90vh; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: rgba(255,255,255,0.03); }
        th, td { padding: 12px; border: 2px solid #333; text-align: center; border-radius: 5px;}
        th { background: rgba(0, 123, 255, 0.5); color: rgba(248, 250, 252, 2); } /* */

        .btn-action { padding: 14px; border-radius: 8px; border: none; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; flex: 1; }
        .btn-action:hover { transform: scale(1.05); filter: brightness(1.2); }

        .admin-badge { background: #6f42c1; color: white; padding: 2px 10px; border-radius: 10px; font-size: 10px; margin-left: 8px; }
        
        /* Teks "Semua ada di kantor" */
        .empty-row { background: white !important; color: black !important; font-weight: bold; }
    </style>
</head>
<body class="bg-login">

<div class="container">
    <div id="login-section">
        <div class="login-box">
            <h2 style="color:#FFD700; letter-spacing: 2px;">LOGIN STAFF</h2>
            <input type="text" id="nik" placeholder="Masukkan Username">
            <input type="password" id="pass" placeholder="Password">
            <button onclick="handleLogin()">Masuk</button>
        </div>
    </div>

    <nav id="sidebar">
        <div style="text-align:center; color:#FFD700; margin-bottom:30px;"><b>EMON-TOTO</b></div>
        <button id="nav-home" onclick="showSection('home')">üè† Home</button>
        <button id="nav-riwayat" onclick="showSection('riwayat')">üìú Riwayat</button>
        <button onclick="logout()" style="margin-top:auto; color:#dc3545;">üö™ Keluar</button>
    </nav>

    <div id="main-content" class="main-content">
        <div id="sec-home">
            <h3>Halo, <span id="user-name">...</span> <span id="role-badge" class="admin-badge" style="display:none">ADMIN</span></h3>
            <div style="display:flex; gap:15px; margin-bottom:30px;">
                <button class="btn-action" style="background:#28a745" onclick="absen('masuk')">Absen Masuk</button>
                <button class="btn-action" style="background:#fd7e14" onclick="absen('pulang')">Absen Pulang</button>
            </div>
            
            <h4>üë• Staf Sedang di Luar</h4>
            <table>
                <thead><tr><th>Nama</th><th>Keluar</th><th>Durasi</th></tr></thead>
                <tbody id="monitor-body"></tbody>
            </table>

            <h4 style="margin-top:30px">Form Izin</h4>
            <select id="keperluan" style="width:100%; padding:14px; background:#1a1a1a; color:white; border-radius:8px; border:1px solid #444;">
                <option value="">-- Pilih Keperluan --</option>
                <option value="toilet">toilet</option>
                <option value="Ambil makan">ambil makan</option>
                <option value="merokok">merokok</option>
                <option value="Istirahat">Istirahat</option>
                <option value="kebutuhan khusus wanita">kebutuhan khusus wanita</option>
            </select>
            <div style="display:flex; gap:10px; margin-top:20px">
                <button onclick="izinKeluar()" class="btn-action" style="background:#007bff">Mulai Izin</button>
                <button onclick="izinKembali()" class="btn-action" style="background:#6c757d">Kembali</button>
            </div>
        </div>

        <div id="sec-riwayat" style="display:none">
            <h3 id="riwayat-title">Riwayat Aktivitas</h3>
            <h4>Log Absensi</h4>
            <table>
                <thead><tr id="head-absen"><th>Tgl</th><th>Masuk</th><th>Pulang</th></tr></thead>
                <tbody id="body-absen"></tbody>
            </table>
            
            <h4 style="margin-top:30px">Log Izin</h4>
            <table>
                <thead><tr id="head-izin"><th>Keluar</th><th>Kembali</th><th>Durasi</th><th>Keperluan</th></tr></thead>
                <tbody id="body-izin"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://crmuanjyoffemqoxqarj.supabase.co";
    const SB_KEY = "sb_publishable_0gKE7N1uNHMNEOzcZIEqHQ_OT4HcAHG";
    const client = supabase.createClient(SB_URL, SB_KEY);
    
    let userSession = null;
    let userRole = 'staf';

    async function checkSession() {
        const { data: { session } } = await client.auth.getSession();
        if (session) {
            userSession = session.user;
            const { data: p } = await client.from('profiles').select('nama_staf, role').eq('id', userSession.id).single();
            userRole = p?.role || 'staf';

            document.querySelector('.container').classList.add('dashboard-active');
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('sidebar').style.display = 'flex';
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('user-name').innerText = p.nama_staf;
            
            if(userRole === 'admin') document.getElementById('role-badge').style.display = 'inline-block';
            showSection('home');
        }
    }
    window.onload = checkSession;

    function showSection(id) {
        document.getElementById('sec-home').style.display = id === 'home' ? 'block' : 'none';
        document.getElementById('sec-riwayat').style.display = id === 'riwayat' ? 'block' : 'none';
        document.body.className = 'bg-' + id;
        document.getElementById('nav-home').className = id === 'home' ? 'active' : '';
        document.getElementById('nav-riwayat').className = id === 'riwayat' ? 'active' : '';
        if(id === 'home') fetchMonitor(); else fetchRiwayat();
    }

    // --- PERBAIKAN FUNGSI YANG SEBELUMNYA ERROR ---
    async function fetchMonitor() {
        const { data: izinAktif } = await client.from('izin').select('user_id, jam_keluar').is('jam_kembali', null);
        const { data: profiles } = await client.from('profiles').select('id, nama_staf');
        let html = '';
        if (izinAktif && izinAktif.length > 0) {
            izinAktif.forEach(iz => {
                const p = profiles?.find(item => item.id === iz.user_id);
                const menit = Math.floor((new Date() - new Date(iz.jam_keluar)) / 60000);
                html += `<tr><td><b>${p?.nama_staf || 'Staf'}</b></td><td>${new Date(iz.jam_keluar).toLocaleTimeString()}</td><td style="color:#ff4d4d">${menit}m</td></tr>`;
            });
        } else {
            html = '<tr><td colspan="3" class="empty-row">Semua ada di kantor.</td></tr>';
        }
        document.getElementById('monitor-body').innerHTML = html;
    }

    async function fetchRiwayat() {
        const { data: dbIzin } = await client.from('izin').select('*').eq('user_id', userSession.id).order('jam_keluar', {ascending: false});
        const { data: dbAbsen } = await client.from('absensi').select('*').eq('user_id', userSession.id).order('waktu_masuk', {ascending: false});
        
        document.getElementById('body-absen').innerHTML = dbAbsen?.map(a => `<tr><td>${new Date(a.waktu_masuk).toLocaleDateString()}</td><td>${new Date(a.waktu_masuk).toLocaleTimeString()}</td><td>${a.waktu_pulang ? new Date(a.waktu_pulang).toLocaleTimeString() : '-'}</td></tr>`).join('') || '';
        
        document.getElementById('body-izin').innerHTML = dbIzin?.map(i => {
            let durasi = "-";
            if (i.jam_kembali) {
                const diff = Math.floor((new Date(i.jam_kembali) - new Date(i.jam_keluar)) / 60000);
                durasi = diff + "m";
            }
            return `<tr><td>${new Date(i.jam_keluar).toLocaleTimeString()}</td><td>${i.jam_kembali ? new Date(i.jam_kembali).toLocaleTimeString() : '-'}</td><td>${durasi}</td><td>${i.keperluan}</td></tr>`;
        }).join('') || '';
    }

    async function handleLogin() {
        const nik = document.getElementById('nik').value;
        const pass = document.getElementById('pass').value;
        const { error } = await client.auth.signInWithPassword({ email: nik + "@kantor.com", password: pass });
        if (error) alert("Login Gagal!"); else location.reload();
    }

    async function absen(tipe) {
        if(tipe === 'masuk') await client.from('absensi').insert([{ user_id: userSession.id, waktu_masuk: new Date().toISOString() }]);
        else await client.from('absensi').update({ waktu_pulang: new Date().toISOString() }).match({ user_id: userSession.id }).is('waktu_pulang', null);
        alert("Berhasil!");
    }

    async function izinKeluar() {
        const ket = document.getElementById('keperluan').value;
        if(!ket) return alert("Pilih alasan!");
        await client.from('izin').insert([{ user_id: userSession.id, keperluan: ket, jam_keluar: new Date().toISOString() }]);
        fetchMonitor();
    }

    async function izinKembali() {
        await client.from('izin').update({ jam_kembali: new Date().toISOString() }).match({ user_id: userSession.id }).is('jam_kembali', null);
        fetchMonitor();
    }

    async function logout() { await client.auth.signOut(); location.reload(); }

// ... fungsi-fungsi lain (fetchMonitor, fetchRiwayat, handleLogin, dll) ...

    // --- 1. Jalankan Jam Digital (Setiap 1 detik) ---
    function updateClock() {
        const now = new Date();
        const h = String(now.getHours()).padStart(2, '0');
        const m = String(now.getMinutes()).padStart(2, '0');
        const s = String(now.getSeconds()).padStart(2, '0');
        const clockElement = document.getElementById('digital-clock');
        if(clockElement) clockElement.innerText = `${h}:${m}:${s}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // --- 2. TAMBAHKAN DI SINI: Auto-Refresh Data (Setiap 30 detik) ---
    setInterval(() => {
        if (userSession) {
            fetchMonitor(); // Memperbarui tabel "Staf Sedang di Luar" secara otomatis
        }
    }, 30000);

</script>  
</script>
</body>

</html>
